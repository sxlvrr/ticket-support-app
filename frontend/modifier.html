<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8" />
  <title>Modifier un ticket</title>
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/babel-standalone@6.26.0/babel.min.js"></script>
</head>
<body>
  <h1>✏️ Modifier un ticket</h1>
  <a href="index.html">⬅️ Retour à l'accueil</a>
  <div id="root"></div>

  <script type="text/babel">
    function App() {
      const params = new URLSearchParams(window.location.search);
      const id = params.get("id");
      const [formData, setFormData] = React.useState({
        titre: '',
        description: '',
        statut: '',
        priorité: '',
        date_creation: '',
        date_mise_a_jour: '',
        id_employe: '',
        id_technicien: ''
      });
      const [message, setMessage] = React.useState('');

      React.useEffect(() => {
        fetch(`http://localhost:5000/tickets/${id}`)
          .then(res => res.json())
          .then(data => {
            setFormData(data);
          });
      }, []);

      const handleChange = (e) => {
        setFormData({ ...formData, [e.target.name]: e.target.value });
      };

      const handleSubmit = (e) => {
        e.preventDefault();
        formData.date_mise_a_jour = new Date().toISOString();

        fetch(`http://localhost:5000/tickets/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(formData)
        })
          .then(res => res.json())
          .then(data => setMessage(data.message))
          .catch(() => setMessage("Erreur lors de la mise à jour ❌"));
      };

      return (
        <form onSubmit={handleSubmit}>
          <input name="titre" value={formData.titre} onChange={handleChange} placeholder="Titre" required /><br />
          <textarea name="description" value={formData.description} onChange={handleChange} placeholder="Description" required /><br />
          <select name="statut" value={formData.statut} onChange={handleChange}>
            <option>Ouvert</option>
            <option>En cours</option>
            <option>Résolu</option>
            <option>Fermé</option>
          </select><br />
          <select name="priorité" value={formData.priorité} onChange={handleChange}>
            <option>Faible</option>
            <option>Moyenne</option>
            <option>Élevée</option>
            <option>Critique</option>
          </select><br />
          <input name="id_employe" value={formData.id_employe} onChange={handleChange} placeholder="ID Employé" /><br />
          <input name="id_technicien" value={formData.id_technicien || ''} onChange={handleChange} placeholder="ID Technicien" /><br />
          <p><strong>Date de création :</strong> {formData.date_creation}</p>
          <p><strong>Date mise à jour :</strong> {formData.date_mise_a_jour}</p>
          <button type="submit">Enregistrer ✅</button>
          {message && <p><strong>{message}</strong></p>}
        </form>
      );
    }

    ReactDOM.createRoot(document.getElementById('root')).render(<App />);
  </script>
</body>
</html>
